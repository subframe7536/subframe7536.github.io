---
alias: os-设备管理
tag:
- 考研
- 829
- os
date: 2022年07月23日
---
![[大纲#设备管理]]
## I/O体系结构
四个层次的系统结构：用户层 IO、设备独立性软件、设备驱动程序、中断处理程序
### 用户层 IO
实现与用户交互的接口
### 设备独立性软件
用于实现用户程序与设备驱动器的统一接口、设备命令、设备保护及设备分配与释放等等，同时为设备管理与数据传送提供必要的存储空间
### 设备驱动程序
与硬件直接相关，负责具体实现系统对设备发出的操作指令，驱动 IO 设备工作的驱动程序
### 中断处理程序
用户保存被中断进程的 CPU 环境，处理完并回复被中断程序的现场后，返回到被中断进程
### 设备控制器的基本功能
1. 接受和识别命令
2. 数据交换
3. 标识和报告设备状态
4. 地址识别
5. 数据缓冲
6. 差错控制
### 设备控制器的组成
1. 设备控制器与处理机接口
2. 设备控制器与设备的接口
3. IO 逻辑
## I/O 控制方法
外围设备与内存的输入输出控制有四种
### 程序直接控制
#### 优点
简单易于实现 
#### 缺点
CPU 和 IO 设备串行工作且需要 CPU 轮询检查，导致 CPU 利用率相当低
### 中断驱动方式
允许 IO 设备主动打断 CPU 运行并请求服务，从而“解放”CPU，使得其向 IO 控制器发出读命令后，可以继续做其他有用的工作
#### 优点
大大提高了 CPU 利用率 
#### 缺点
数据中每个字在存储器与 IO 设备控制器之间的传输必须经过 CPU，导致了终端驱动仍然会消耗较多的 CPU 时间
### DMA 方式（直接存储器存取）
在 IO 设备和内存之间开辟直接的数据交换通路，彻底解放 CPU
#### 特点
- 基本单位：块
- 所传送的数据，是从设备直接送入内存的，或者相反
- 仅在传送一个或多个数据块开始或结束时，才需要 CPU 的干预，整块数据的传送是在 DMA控制器的控制下完成的
### DMA 控制器
#### 组成（机组要求 P168）
#### 工作方式
CPU 接到 DMA 的工作请求时，给 IO 控制器发一条命令，启动 DMA 控制器，然后继续其他工作。DMA 控制器直接与存储器交互，传送整个数据块，每次传送一个**字**，这个过程不需要CPU 的参与。传送完成后，DMA 控制器发送一个中断信号给 CPU
#### 中断驱动方式的区别
- 中断驱动方式在每个数据传送需要中断 CPU，而 DMA控制方式则是在所要求传送的一批数据全部传送结束时才中断 CPU 
- 中断驱动方式数据传送是在中断处理时由 CPU 控制完成，而 DMA 控制方式则是在 MA 控制器的控制下完成的
### 通道控制方式：
#### 概念
是指专门负责输入输出的处理机，是 DMA 方式的发展，他可以进一步减少 CPU 的干预
- 对**一组数据块**的读写的及有关控制和管理为单位的干预
- 实现 CPU、通道和 IO 设备三者的**并行操作**，从而更有效的提高整个系统的资源利用率。
#### 与一般处理机的区别
通道指令的类型单一，没有自己的内存，与 CPU 共享内存。
#### 与 DMA 方式的差别
DMA 方式需要 CPU 来控制和传输数据块的大小以及传输的内存位置，而通道方式中的这些信息是由通道控制的
另外，每个 DMA 控制器对应一台设备与内存传递数据，而一个通道可以控制多台设备与内存的数据交换
## 通道和通道程序
### 概念
一种特殊的处理机，具有执行 IO 指令的能力，并通过执行通道程序来控制 IO 操作
### 类型
#### 字节多路通道
按字节交叉方式工作，含有许多非分配型子通道，这些子通道按时间片转轮方式共享主通道
只要扫描各子通道速度足够快，而连接到子通道设备速率不是太高时，不会丢失信息
- 不适用于连接高速设备
#### 数组选择通道
可以连接多台高速设备，但只有一个分配型子通道，在一段时间内只能执行一道通道程序
- 通道利用率极低
#### 数组多路通道
前两者优点结合
- 很高的数据传送速率
- 很高的 CPU 利用率
### 瓶颈问题
通道价格昂贵，因此较少，通道不足会造成瓶颈问题
#### 解决方法
增加设备到主机间的通路，而不增加通道
为了防止出现瓶颈，通常采用多通路的 IO 系统结构
### 通道程序
通过执行**通道程序**，并与设备控制器共同实现：通道对 IO 设备的控制
由一系列通道指令（命令）构成，与一般机器指令不同，每条指令中都包含如下信息
1. 操作码
2. 内存地址
3. 技计数
4. 通道程序结束位
5. 记录结束标志
## 设备独立性及其实现方法
为提高 OS 的可适应性和可扩展性，必须实现设备独立性（设备无关性）
### 基本含义
应用程序独立于具体使用的物理设备
#### 好处
1. 设备分配时的灵活性
2. 易于实现 IO 重定向。
### 实现方法
在应用程序中使用逻辑设备名来请求使用某类设备，在系统中设置一张逻辑设备表（LUT），用于将逻辑设备名映射成物理设备名
#### 内容
1. 逻辑设备名
2. 物理设备名
3. 设备驱动程序的入口地址
#### 建立逻辑设备表的两种方式
1. 在整个系统中只设置一张 LUT，适用于单用户系统
2. 为每个用户设置一张 LUT
## 虚拟设备和 SPOOLing 技术
### 定义
将一台物理 IO 设备虚拟为多台逻辑 IO 设备，允许多个用户共享一台物理 IO 设备。实质上是一种**以空间换时间**的技术，而请求分页的页面调度算法时典型的以时间换空间。
SPOOLing 是对脱机输入、输出系统的模拟，必须建立在**多道程序**功能的基础上，而且还要有**高速随机外存**的支持，通常采用**磁盘存储**技术。
### 三个部分
#### 输入井和输出井
在磁盘上开辟的两个大存储空间
- 输入井：模拟脱机输入的磁盘设备，用于暂存 IO 设备输出的数据
- 输出井：模拟脱机输出的设备，用于暂存用户程序输出的数据
#### 输入缓冲区和输出缓冲区
为缓和 CPU 和 IO 设备速度不匹配的矛盾，在内存中开辟两个缓冲区：输入和输出缓冲区，
- 输入缓冲区：暂存从**输入设备**送来的数据，再传送到**输入井**
- 输出缓冲区：暂存从**输出井**送来的数据，再传送给**输出设备**
#### 输入进程和输出进程
利用这两个进程模拟脱机 IO 时的外围控制机
- 输入进程模拟脱机输入时的外围控制机，将用户要求输入的数据从输入机通过输入缓冲区送到输入井，当 CPU 需要输入数据时，直接从输入井读到内存
- 输出进程模拟输出时的外围控制机，把用户要求输出的数据先从内存送到输出井，待输出设备空闲时，再将输出井中的数据经过输出缓冲区送到输出设备上
### 例子
打印机是经常要用到的独占输出设备
利用 SPOOLing 可以改造成共多个用户共享的设备，从而提高设备利用率
## 缓冲管理
### 引入缓冲区的主要原因
1. 缓和 CPU 和 IO 设备间速度的不匹配的矛盾 
2. 减少对 CPU 的中断频率，放宽 CPU 中断响应时间的限制 
3. 提高 CPU 和 IO 设备之间的并行性
	1. 缓冲区数据非空时，不能往缓冲区冲入数据，只能把数据传出
	2. 当缓冲区为空时，可以冲入数据，但必须把缓冲区充满后，才能从缓冲区把数据传出
### 分类
#### 单缓冲
- 从磁盘把一块数据输入到缓冲区的时间为 T
- 缓冲区的数据送到用户区的时间为 M
- CPU 对这块数据的处理时间为 C
- T 和 C 是可以并行的，因此处理时间表示为 `max{T,C}+M`
#### 双缓冲
为了加快输入输出速度，提高设备利用率，引入双缓冲（缓冲对换）
处理一块数据所用时间为 `max{C+M,T}`
- 单缓冲机制不允许双方同时向对方发送数据，而双缓冲可以
#### 循环缓冲
包含多个大小相等的缓冲区，每个缓冲区由一个链接指针指向下一个缓冲区，构成一个环形
#### 缓冲池
在池中设置多个可供进程共享的缓冲区
##### 组成
1. 空闲缓冲区（空缓冲队列）
2. 装满输入数据的缓冲区（输入缓冲队列）
3. 装满输出数据的缓冲区（输出缓冲队列）
## 设备处理与I/O软件
### 总体设计目标
高效率、通用性
### IO 软件应实现的目标
1. 与具体设备无关
2. 统一命名 
3. 错误处理
4. 缓冲技术
5. 设备分配和释放
6. IO 控制方式
### 四个层次
用户层软件、设备独立性软件、设备驱动程序、中断处理程序。
## 设备分配
### 数据结构
在设备分配时，通常用：设备控制表、控制器控制表、通道控制表、系统设备表
#### 设备控制表（DCT）
每个设备配备一张设备控制表，用于记录本设备的情况
![[5.设备管理-20220724.png]]
#### 控制器控制表（COCT）
系统为每个控制器设置了一张用于记录本控制情况的控制器控制表
![[5.设备管理-20220724-1.png]]
#### 通道控制表（CHCT）
每个通道都配有一张通道控制表
![[5.设备管理-20220724-2.png]]
#### 系统设备表（SDT）
这是系统范围的数据结构，记录了系统中全部设备的情况。每个设备占有一个表目，其中包括设备类型，设备标识符，设备控制表以及设备驱动程序的入口等
![[5.设备管理-20220724-3.png]]
### 分配方法
#### 设备分配时应考虑到的因素
1. 设备固有属性
2. 设备分配算法
3. 设备分配时的安全性
4. 设备独立性
#### 设备固有属性
1. 独占性设备
2. 共享性设备
3. 可虚拟设备
#### 分配算法
先来先服务、优先级高者有优先
#### 安全性
##### 安全分配方式
放弃了“请求和保持”条件，CPU 与 IO 串行工作 
##### 不安全分配方式
可能造成死锁。










