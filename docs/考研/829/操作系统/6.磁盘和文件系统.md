---
alias: os-磁盘和文件系统
tag:
- 考研
- 829
- os
date: 2022年07月24日
---
![[大纲#磁盘与文件系统]]
## 磁盘的结构和基本概念
磁盘设备包括多或一个个物理盘片，每个磁盘片分为一个或两个储存面
每个磁盘被组织成若干个同心环，称为磁道
每个磁道从逻辑上划分为多个扇区（通常为 512B），一个扇区称为一个盘块（数据块），各个扇区之间保留一定的间隙。
### 磁盘地址
柱面号-盘面号-扇区号
### 磁盘访问时间
由寻道时间、旋转延迟时间、传输时间组成
#### 寻道时间
把磁头移动到指定磁道上的时间
- `T=m*n+s`，移动磁臂时间 s 与磁头移动 n 条磁道所花费时间之和
#### 旋转延迟时间
指扇区移动到磁头下面所经历的时间
- `T=1/2r`，r 为磁盘旋转速度
#### 传输时间
把数据从磁盘读入或写入磁盘所经历的时间
- `T=b/r*N`，b 为每次所读的字节数，N 为一个磁道上的字节数。
## 磁盘的调度
调度算法直接决定寻找时间，从而决定总的存取时间
### 调度算法
#### 先来先服务（FCFS）
先访问最先的请求
#### 最短寻找时间优先（SSTF）
贪心寻找最近的磁道
#### 扫描算法（SCAN）
只有磁道移动到最边缘才改变磁头方向
#### 循环扫描算法（C-SCAN）
只有磁道移动到最边缘才改变磁头方向，改变方向后不处理请求，直接返回另一侧最边缘
## 磁盘的性能改善和容错
### 磁盘高速缓存
利用内存中的存储空间来暂存从磁盘读出一系列盘块中的信息
### 数据交付方式
#### 数据交付
直接给数据
#### 指针交付
给数据所在的指针，数据量小可以节省时间
### 置换算法
最近最久未使用算法 LRU、最近未使用算法 NRU 及最少使用算法 LFU 等
#### 还需考虑
1. 访问频率
2. 可预见性
3. 数据一致性
### 其他方法
提前读、延迟写、优化物理块分布（交替分布） 、虚拟盘
### 容错技术
廉价磁盘冗余阵列 RAID
RAID0 ~ RAID7
#### 优点
1. 可靠性高，其他的都有容错技术（0级除外）
2. 并行传输，IO 速度快
3. 性价比高
#### 优点
可靠性高、磁盘 IO 速度高、性价比高
## 外存分配方法与物理文件组织
文件的物理结构又称文件的存储结构，是指文件在外存上的存储组织形式，不仅与存储介质
的存储性能有关，而且与采用的外存分配方式有关
### 连续分配
要求为每个文件分配一组相邻的盘块。一组盘块的地址定义了定义了磁盘上一段线性地址，这样形成的文件结构是顺序文件结构，此时的物理文件称为顺序文件
#### 优点
顺序访问容易、顺序访问速度快
#### 缺点
要求有连续的存储空间、必须事先知道文件长度
### 链接分配
通过每个盘块上的链接指针，将同属于一个文件的离散盘块链接成一个链表，这样形成的物理文件称为链接文件
#### 优点
- 消除了外部碎片，显著提高外存利用率
- 动态分配盘块，无需事先知道文件大小
- 方便对文件的增删改
#### 隐式链接
在文件目录的每个目录项中，都需要含有指向链接文件的第一个盘块和最后一个盘块，每个盘块中含有指向下一个盘块的指针
##### 主要问题
1. 只适合于顺序访问，随机访问极其低效
2. 只通过一大批指针把离散的盘块链接起来，可靠性差，只要任何一个盘块的指针出现问题，都将会导致整条链断裂
##### 解决方法
为了提高检索速度和减少指针所占用的存储空间，可以将几个盘块组成一个簇，在盘块分配时，以簇为单位
#### 显式链接
把用于链接文件各个物理块的指针，存放在**内存中的**一张链接表（又称文件分配表FAT）
- 整个磁盘仅设置一张
- 显著提高检索的速度
- 大大减少访问磁盘的次数
### 索引分配
为每个文件分配一个索引块（表），再把分配给该文件的所有盘块号都记录在该索引块中
在建立一个文件时，只需在为其建立的目录项中添加指向该索引块的指针即可
#### 物理组织结构
索引式文件机构
#### 链接分配的缺点
1. 不支持高效的直接存取
2. FAT 占用较大的内存空间
#### 索引分配优点
- 支持直接访问
- 不会产生外部碎片
- 文件较大时，索引优于链接
#### 缺点
可能会花费较多的外存空间。
#### 多级索引
对索引表进行索引
#### 混合索引
既采用直接地址，又采用多级索引分配方式
##### 直接索引
10个直接地址项存放索引地址
##### 一次间接索引
超出10个，可以存放1K个间接索引地址
##### 多次间接索引
超过一次间址与 10 个直接地址项，使用多级索引
## 文件存储空间的管理
基本分配单位：磁盘块
管理包括对**空闲块**的组织，分配和回收
### 空闲表法
属于连续分配方式，系统为外存上所有的空闲区建立一张空闲表
#### 存储空间的分配
同样采取首次适应算法，循环首次适应算法等，回收时，也类似于内存回收的方法，即要考虑回收区是否与空闲表中插入点的前区和后区相临接，对相临接者予以合并
- 文件较小时，采取空闲表法。
### 空闲链表法
将所有空闲盘区拉成一条空闲链
#### 空闲盘块链
以盘块为单位拉成一条链
##### 优点
分配和回收一个盘块的过程非常简单
##### 缺点
为一个文件分配盘块时，可能要重复操作多次
#### 空闲盘区链
将磁盘上所有的空闲盘区拉成一条链
分配盘区的算法通常采用首次适应算法，回收时也要考虑合并，为提高对空闲盘区的检索速度，可以采用显示连接法，为内存中的空闲盘区建立一张链表。
### 位示图法
位示图是利用二进制中的一位来表示磁盘中一个盘块的使用情况，0时空闲，1时分配
#### 分配
1. 顺序扫描位示图，找到 0
2. 将找到的一个或一组二进制位转化成与之相对应的盘块号
3. 修改位示图，使相应位置 1
##### 行列号转盘块号
`b=n(i-1)+j`（行列号从1开始）
#### 回收
1. 将回收的盘块号转化为位示图中的行号和列号
2. 修改位示图，使相应位置 0
##### 盘块号转行列号
`i=(b-1)/n+1, j=(b-1)%n+1`（行列号从1开始）
### 成组链接法
空闲表法和空闲链表法不适合大型文件，会使链表和空闲表太长
#### 大致思想
结合上述的优点，把顺序的 n 个空闲扇区的地址保存在第一个空闲扇区内，其后一个空闲扇区则保存另一个顺序空闲扇区的地址，在直至所有空闲扇区均已连接
- 系统只需要保存一个指向第一个空闲扇区的指针
## 逻辑文件组织
文件的逻辑结构是从用户观点出发所观察到的文件组织形式，是用户可以直接处理的数据及其结构，独立于文件的物理特性，又称为文件组织。
### 文件逻辑结构的类型
有结构文件（顺序、索引、索引顺序）、无结构文件（txt）
#### 顺序文件
由一系列记录按某种顺序排列所形成的文件，记录通常是记录文件。又分为串结构和顺序结构。串结构，记录之间的顺序与关键字无关。顺序结构，所有记录按关键字顺序排列。
##### 优点
只有顺序文件能储存在磁带上，当每次要读或写一大批文件时，顺序文件的存储效率最高
##### 缺点
顺序文件对于查找、修改、增加、删除等操作比较困难
#### 索引文件
对于定长记录可以方便的实现顺序存取，但对于变长记录难以实现直接存取
可以为变长文件记录建立一张索引表（本身是一个定长记录的顺序文件）
#### 顺序索引文件
将顺序文件中的所有记录分为若干组，为顺序文件建立一张索引表，在索引表中为魅族第一条记录建立一个索引项，其中含有该记录的关键字值，和指向该记录的指针
### 直接文件
记录值本身就决定了自己的物理地址，键值转换 
### 哈希文件
利用散列函数，将键值转化为相应的记录的地址，可能会发生冲突
## 文件的基本操作
### 创建文件
在创建一个新文件时，系统首先要为新文件分配必要的外存空间，并在文件系统的目录中，为之建立一个目录项，目录项中应记录新文件的文件名及其在外存的地址等属性
### 删除文件
系统先从目录中找到要删除文件的目录项，使之成为空项，然后回收该文件占用的存储空间
### 读文件
在读一个文件时，须在相应系统调用中给出文件名和应读入的内存目标地址
在目录项中，还有一个指针用于对文件的读/写。
### 写文件
在写一个文件时，须在相应系统调用中给出该文件名及该文件在内存中的地址，利用目录中的写指针进行写操作。
### 截断文件
将原有文件的长度设置为 0，或者说是放弃原有的文件内容
### 设置文件的读/写位置
设置文件读/写指针的位置，改顺序存取为随机存取
### 打开文件
当系统将指名文件的属性(包括该文件在外存上的物理位置)从外存拷贝到内存打开文件表的一个表目中，并将该表目的编号(或称为索引)返回给用户
### 关闭文件
系统把该文件从打开文件表中的表目上删除掉
## 文件目录及其管理
对目录管理的要求
1. 实现“按名存取”
2. 提高对目录的检索速度 
3. 文件共享
4. 允许文件重名
### 文件控制块（FCB）
存放控制文件所需要的各种控制信息的数据结构。文件控制块的有序集合称为文件目录，即一个文件控制块就是一个文件目录项。一个文件目录也可以看做一个文件，称为目录文件
#### 基本信息
记录文件名，文件物理位置，文件逻辑结构，文件物理结构
#### 存取控制信息
记录文件存取权限
#### 使用信息
记录文件建立时间，修改时间
### 索引结点
文件名与文件描述信息分开的数据结构
在文件目录中，每个目录项仅由**文件名**和指向该文件所对应的 i 结点的**指针**构成
### 目录结构
#### 单级目录
只建立一张目录表，每个文件占一个目录项
访问时，按文件名在该目录中找到对应的 FCB
##### 缺点
查找速度慢，不允许重名，不便于实现文件共享
#### 两级目录
##### 优点
- 提高了检索目录的速度；在不同用户名的目录中，可以使用相同文件名
- 不同用户可以使用不同的文件名来访问系统中的同一个共享文件
#### 多级目录文件（树形目录文件）
##### 优点
可以很方便的对文件进行分类，层次结构清晰，能有效的进行文件的管理和保护
##### 缺点
查找一个文件时，需要按路径名逐级访问，增加了磁盘访问次数，影响查询速度
## 文件共享和保护
文件共享是多个用户共享同一文件，系统只要保留该文件的一个副本。
### 文件共享方法
1. 基于索引结点的共享方式（硬链接） 
2. 利用符号链实现文件共享（软连接）
### 文件保护
文件保护通过口令保护，加密保护，访问控制等方式实现
- 口令保护和加密保护是为了防止用户文件被他人存取或窃取
- 访问控制是控制用户对文件的访问方式
#### 引入检查点的目的
对事务记录表中的事务记录清理工作经常化
### 事务
一个事务在对一批数据执行修改操作时，要么全部完成，并用修改后的数据去代替原来的数据，要么一个也不修改
### 并发控制
#### 互斥锁
仅允许一个事务对相应对象执行读或写操作
#### 共享锁
允许多个事务对相应对象执行读操作，不允许其中任何一个事务对对象执行写操作
